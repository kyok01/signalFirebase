<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/demo-style.css" />
    <link rel="stylesheet" href="../css/tomorrow-night.css" />
    <title>oCADisplay Method Demo</title>
  </head>
  <body>
    <header>
      <a href="../index.html">
        <div>signalFirebase</div>
      </a>
    </header>
    <main>
      <h1>oCADisplay Method Demo</h1>
      <p>
        oCADisplay is mainly made of onChildAdded function.<br />You can
        customize when it works.
      </p>
      <h2>Output</h2>
      <div id="output">
        <table>
          <thead>
            <tr>
              <th>Chat ID</th>
              <th>User Name</th>
              <th>Age</th>
              <th>Text</th>
            </tr>
          </thead>
          <tbody id="output__tbody"></tbody>
        </table>
      </div>
      <h2>Executed Code</h2>
      <div id="code"></div>
      <h2>Reference</h2>
      <div id="reference">
        <pre
          class="prettyprint"
        ><code>sg("xxxxx").oCADisplay(mainFunc, onLoadBool, RealTimeBool);</code></pre>
        <p>
          oCADisplay is mainly made of onChildAdded function.<br />You can
          customize when it works.
        </p>
        <h3>Parameters</h3>
        <table>
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>mainFunc</td>
              <td>function</td>
              <td>
                This function will be executed when oCADisplay method is
                executed. This function must have only one parameter and this
                has to be
                <a
                  href="https://firebase.google.com/docs/reference/js/database.datasnapshot?authuser=0"
                  >DataSnapshot</a
                >
                class object
              </td>
            </tr>
            <tr>
              <td>onLoadBool</td>
              <td>boolean</td>
              <td>
                You can decide whether you execute mainFunc when the page is
                loaded.
              </td>
            </tr>
            <tr>
              <td>RealTimeBool</td>
              <td>boolean</td>
              <td>
                You can decide whether you execute mainFunc when Realtime
                Database have child_added event.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <h2>Change Parameters and Execute</h2>
      <div id="custom">
        <div id="custom__df">
          <div>sg("chat").oCADisplay(</div>
          <div>
            <div>mainFunc,</div>
            <div>
              <select name="" id="custom__mainFunc">
                <option value="appendDemo">appendDemo</option>
                <option value="prependDemo">prependDemo</option>
              </select>
            </div>
          </div>
          <div>
            <div>onLoadBool,</div>
            <div>
              <select name="" id="custom__onLoadBool">
                <option value="1">true</option>
                <option value="0">false</option>
              </select>
            </div>
          </div>
          <div>
            <div>
              RealTimeBool
            </div>
            <div>
              <select name="" id="custom__RealTimeBool">
                <option value="1">true</option>
                <option value="0">false</option>
              </select>
            </div>
          </div>
          <div>);</div>
        </div>
        <button id="custom__execute">Reload and Execute!!</button>
      </div>
      <h2>Trigger Child Event(β)</h2>
      <div id="childEvent">
        <p>
          If you push the trigger button below, you execute this code.You will
          add a childData.<br />(Automatically remove the childData in 3
          seconds.)
        </p>
        <pre
          class="prettyprint"
        ><code>set(ref(db, 'chat/-N2qurrOFc4woZCUOK8T'), {uname:"Mia", age:28, text:"Good night!", deleteFrag:false});<br>//-N2qurrOFc4woZCUOK8T is randam number, usually mede by push function</code></pre>
        <button id="childEvent__trigger">
          Trigger Child Event and Watch What happens!!
        </button>
      </div>
    </main>
    <footer>
      <div>Copyright (c) 2022 Kazutaka.Yokoi</div>
      <div>Released under the MIT license</div>
      <div>
        <a href="https://opensource.org/licenses/MIT"
          >https://opensource.org/licenses/MIT</a
        >
      </div>
    </footer>
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->

    <!--** 以下Firebase **-->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onChildAdded,
        remove,
        onChildRemoved,
        update,
        onChildChanged,
        get,
        child,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      import {
        envapiKey,
        envauthDomain,
        envdatabaseURL,
        envprojectId,
        envstorageBucket,
        envmessagingSenderId,
        envappId,
      } from "../js/env.js";

      import { sg } from "../js/signalFirebase.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: envapiKey,
        authDomain: envauthDomain,
        databaseURL: envdatabaseURL,
        projectId: envprojectId,
        storageBucket: envstorageBucket,
        messagingSenderId: envmessagingSenderId,
        appId: envappId,
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const dbRef = ref(db, "chat");

      //Global variable
      let oCADisplayMainFunc;
      let oCADisplayOnLoadBool;
      let oCADisplayRealTimeBool;

      oCADisplayMainFunc = localStorage.getItem("oCADisplayMainFunc");
      oCADisplayOnLoadBool = localStorage.getItem("oCADisplayOnLoadBool");
      oCADisplayRealTimeBool = localStorage.getItem("oCADisplayRealTimeBool");

      // functions
      $(function () {
        $("html,body").animate({ scrollTop: 0 }, "0.5");
      });

      const appendDemo = function (data) {
        $("#output__tbody").append(
          `<tr><td>${data.key}</td><td>${data.val().uname}</td><td>${
            data.val().age
          }</td><td>${data.val().text}</td></tr>`
        );
      };

      const prependDemo = function (data) {
        $("#output__tbody").prepend(
          `<tr><td>${data.key}</td><td>${data.val().uname}</td><td>${
            data.val().age
          }</td><td>${data.val().text}</td></tr>`
        );
      };

      const wait = (sec) => {
        return new Promise((resolve, reject) => {
          setTimeout(resolve, sec * 1000);
        });
      };

      if (
        oCADisplayMainFunc == null ||
        oCADisplayOnLoadBool == null ||
        oCADisplayRealTimeBool == null
      ) {
        sg("chat").oCADisplay(appendDemo, true, true);
        $("#code").html(
          '<pre class="prettyprint"><code>' +
            "const appendDemo = function (data) {<br>" +
            ' $("#output__tbody").append(<br>' +
            // "  &lt;div&gt;${data.key}, ${data.val().uname}, ${data.val().age}, ${data.val().text}&lt;\/div&gt;<br>" +
            "  &lt;tr&gt;&lt;td&gt;${data.key}&lt;\/td&gt;&lt;td&gt;${data.val().uname}&lt;\/td&gt;&lt;td&gt;${data.val().age}&lt;\/td>&lt;td&gt;${data.val().text}&lt;\/td&gt;&lt;\/tr&gt;<br>" +
            " );<br>" +
            "};<br>" +
            'sg("chat").oCADisplay(appendDemo, true, true);</code></pre>'
        );
      } else if (oCADisplayMainFunc == "appendDemo") {
        console.log("append");
        console.log(Boolean(Number(oCADisplayOnLoadBool)));
        console.log(Boolean(Number(oCADisplayRealTimeBool)));
        sg("chat").oCADisplay(
          appendDemo,
          Boolean(Number(oCADisplayOnLoadBool)),
          Boolean(Number(oCADisplayRealTimeBool))
        );
        $("#code").html(
          '<pre class="prettyprint"><code>' +
            "const appendDemo = function (data) {<br>" +
            ' $("#output__tbody").append(<br>' +
            "  &lt;tr&gt;&lt;td&gt;${data.key}&lt;\/td&gt;&lt;td&gt;${data.val().uname}&lt;\/td&gt;&lt;td&gt;${data.val().age}&lt;\/td>&lt;td&gt;${data.val().text}&lt;\/td&gt;&lt;\/tr&gt;<br>" +
            " );<br>" +
            "};<br>" +
            `sg("chat").oCADisplay(appendDemo, ${Boolean(
              Number(oCADisplayOnLoadBool)
            )}, ${Boolean(Number(oCADisplayRealTimeBool))});</code></pre>`
        );
        clearLocalStorage();
      } else if (oCADisplayMainFunc == "prependDemo") {
        console.log("preppend");
        sg("chat").oCADisplay(
          prependDemo,
          Boolean(Number(oCADisplayOnLoadBool)),
          Boolean(Number(oCADisplayRealTimeBool))
        );
        $("#code").html(
          '<pre class="prettyprint"><code>' +
            "const appendDemo = function (data) {<br>" +
            ' $("#output__tbody").prepend(<br>' +
            "  &lt;tr&gt;&lt;td&gt;${data.key}&lt;\/td&gt;&lt;td>${data.val().uname}&lt;\/td&gt;&lt;td&gt;${data.val().age}&lt;\/td>&lt;td&gt;${data.val().text}&lt;\/td&gt;&lt;\/tr&gt;<br>" +
            " );<br>" +
            "};<br>" +
            `sg("chat").oCADisplay(appendDemo, ${Boolean(
              Number(oCADisplayOnLoadBool)
            )}, ${Boolean(Number(oCADisplayRealTimeBool))});</code></pre>`
        );
        clearLocalStorage();
      }

      $("#custom__execute").on("click", function () {
        console.log($("#custom__mainFunc").val());
        console.log(
          $("#custom__onLoadBool").val(),
          typeof $("#custom__onLoadBool").val()
        );

        console.log(Boolean(Number($("#custom__onLoadBool").val())));
        localStorage.setItem(
          "oCADisplayMainFunc",
          $("#custom__mainFunc").val()
        );
        localStorage.setItem(
          "oCADisplayOnLoadBool",
          $("#custom__onLoadBool").val()
        );
        localStorage.setItem(
          "oCADisplayRealTimeBool",
          $("#custom__RealTimeBool").val()
        );

        location.reload();
      });

      $("#childEvent__trigger").on("click", async function () {
        set(ref(db, "chat/-N2qurrOFc4woZCUOK8T"), {
          uname: "Mia",
          age: 28,
          text: "Good night!",
          deleteFrag: false,
        });
        $("html,body").animate({ scrollTop: 0 }, "0.5");
        await wait(3);
        remove(ref(db, "chat/-N2qurrOFc4woZCUOK8T"));
      });

      function clearLocalStorage() {
        localStorage.removeItem("oCADisplayMainFunc");
        localStorage.removeItem("oCADisplayOnLoadBool");
        localStorage.removeItem("oCADisplayRealTimeBool");
      }
    </script>
  </body>
</html>
