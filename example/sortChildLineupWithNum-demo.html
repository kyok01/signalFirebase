<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/demo-style.css" />
    <link rel="stylesheet" href="../css/tomorrow-night.css" />
    <title>sortChildLineupWithNum Method Demo</title>
  </head>
  <body>
    <header>
      <a href="../index.html">
        <div>signalFirebase</div>
      </a>
    </header>
    <main>
      <h1>sortChildLineupWithNum Method Demo</h1>
      <p>
        sortChildLineupWithNum is mainly made of onValue, query and
        orderByChild<br />You can make rank table easily.
      </p>
      <h2>Output</h2>
      <div id="output">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>User Name</th>
              <th>Age</th>
            </tr>
          </thead>
          <tbody id="output__tbody"></tbody>
        </table>
      </div>
      <h2>Executed Code</h2>
      <div id="code"></div>
      <h2>Reference</h2>
      <div id="reference">
        <pre class="prettyprint"><code>sg("xxxxx").(value,<br>
          initFunc,<br>
          mainFunc,<br>
          order = "desc",<br>
          tiedRankBool = true,<br>
          onLoadBool = true,<br>
          RealTimeBool = true<br>
        );</code></pre>
        <p>
          sortChildLineupWithNum is mainly made of onValue, query and
          orderByChild<br />You can make rank table easily.
        </p>
        <h3>Parameters</h3>
        <table>
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Type</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>value</td>
              <td>any</td>
              <td>
                You can order "xxxxx"'s childdata by this value.
              </td>
            </tr>
            <tr>
              <td>initFunc</td>
              <td>function</td>
              <td>
                This function will be executed first and once when value event
                is triggered. This function must have only one parameter and
                this has to be
                <a
                  href="https://firebase.google.com/docs/reference/js/database.datasnapshot?authuser=0"
                  >DataSnapshot</a
                >
                class object. This dataSnapshot is made of "xxxxx".
              </td>
            </tr>
            <tr>
              <td>mainFunc</td>
              <td>function</td>
              <td>
                This function will be executed repeatly. This function must have
                only three parameters, "xxxxx"'s childData key, "xxxxx"'s
                childData value and rank number.
              </td>
            </tr>
            <tr>
              <td>order</td>
              <td>string</td>
              <td>
                You can give rank each childdata by desc or asc. Initial value
                is "desc".
              </td>
            </tr>
            <tr>
              <td>tiedRankBool</td>
              <td>boolean</td>
              <td>
                If several data has the same value, you can choose to use tied
                rank, or not. Initial value is true.
              </td>
            </tr>
            <tr>
              <td>onLoadBool</td>
              <td>boolean</td>
              <td>
                You can decide whether you execute mainFunc when the page is
                loaded. Initial value is true.
              </td>
            </tr>
            <tr>
              <td>RealTimeBool</td>
              <td>boolean</td>
              <td>
                You can decide whether you execute mainFunc when Realtime
                Database have child_added event. Initial value is true.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <h2>Change Parameters and Execute</h2>
      <div id="custom">
        <div>
          sg("chat").sortChildLineupWithNum(
          <div id="custom__dfColum">
            <div>
              value,<select name="" id="customML__value">
                <option value="age">age</option>
              </select>
            </div>
            <div>
              initFunc,<select name="" id="customML__initFunc">
                <option value="initFuncDemo">initFuncDemo</option>
              </select>
            </div>
            <div>
              mainFunc,<select name="" id="customML__mainFunc">
                <option value="mainFuncDemo">mainFuncDemo</option>
              </select>
            </div>
            <div>
              order,<select name="" id="customML__order">
                <option value="desc">"desc"</option>
                <option value="asc">"asc"</option>
              </select>
            </div>
            <div>
              tiedRankBool,<select name="" id="customML__tiedRankBool">
                <option value="1">true</option>
                <option value="0">false</option>
              </select>
            </div>
            <div>
              onLoadBool,<select name="" id="customML__onLoadBool">
                <option value="1">true</option>
                <option value="0">false</option>
              </select>
            </div>
            <div>
              RealTimeBool,<select name="" id="customML__RealTimeBool">
                <option value="1">true</option>
                <option value="0">false</option>
              </select>
            </div>
          </div>
          <div>);</div>
        </div>
        <button id="custom__execute">Reload and Execute!!</button>
      </div>
      <h2>Trigger Child Event(β)</h2>
      <div id="childEvent">
        <p>
          If you push the trigger button below, you execute this code.You will
          add a childData.<br />(Automatically remove the childData in 3
          seconds.)
        </p>
        <pre
          class="prettyprint"
        ><code>set(ref(db, 'chat/-N2qurrOFc4woZCUOK8T'), {uname:"Mia", age:28, text:"Good night!", deleteFrag:false});<br>//-N2qurrOFc4woZCUOK8T is randam number, usually mede by push function</code></pre>
        <button id="childEvent__trigger">
          Trigger Child Event and Watch What happens!!
        </button>
      </div>
    </main>
    <footer>
      <div>Copyright (c) 2022 Kazutaka.Yokoi</div>
      <div>Released under the MIT license</div>
      <div>
        <a href="https://opensource.org/licenses/MIT"
          >https://opensource.org/licenses/MIT</a
        >
      </div>
    </footer>
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->

    <!--** 以下Firebase **-->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onChildAdded,
        remove,
        onChildRemoved,
        update,
        onChildChanged,
        get,
        child,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      import {
        envapiKey,
        envauthDomain,
        envdatabaseURL,
        envprojectId,
        envstorageBucket,
        envmessagingSenderId,
        envappId,
      } from "../js/env.js";

      import { sg } from "../js/signalFirebase.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: envapiKey,
        authDomain: envauthDomain,
        databaseURL: envdatabaseURL,
        projectId: envprojectId,
        storageBucket: envstorageBucket,
        messagingSenderId: envmessagingSenderId,
        appId: envappId,
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const dbRef = ref(db, "chat");

      //Global variable
      // sCLWNValue = localStorage.getItem("sCLWNValue");
      // sCLWNInitFunc = localStorage.getItem("sCLWNInitFunc");
      // sCLWNMainFunc = localStorage.getItem("sCLWNMainFunc");
      let sCLWNOrder = localStorage.getItem("sCLWNOrder");
      let sCLWNTiedRankBool = localStorage.getItem("sCLWNTiedRankBool");
      let sCLWNOnLoadBool = localStorage.getItem("sCLWNOnLoadBool");
      let sCLWNRealTimeBool = localStorage.getItem("sCLWNRealTimeBool");

      // functions
      $(function () {
        $("html,body").animate({ scrollTop: 0 }, "0.5");
      });

      const initFuncDemo = function (snapshot) {
        $("#output__tbody").html("");
      };

      const mainFuncDemo = function (key, value, rankNum) {
        $("#output__tbody").append(
          `<tr><td>rank ${rankNum}</td><td>${value.uname}</td><td>${value.age} years old</td></tr>`
        );
      };

      const wait = (sec) => {
        return new Promise((resolve, reject) => {
          setTimeout(resolve, sec * 1000);
        });
      };

      if (
        sCLWNOrder == null ||
        sCLWNTiedRankBool == null ||
        sCLWNOnLoadBool == null ||
        sCLWNRealTimeBool == null
      ) {
        sg("chat").sortChildLineupWithNum("age", initFuncDemo, mainFuncDemo);
        $("#code").html(
          '<pre class="prettyprint"><code>' +
            "const initFuncDemo = function (snapshot) {<br>" +
            '  $("#output__tbody").html("");<br>' +
            "};<br>" +
            "const mainFuncDemo = function (key, value, rankNum) {<br>" +
            '  $("#output__tbody").append(<br>' +
            "    &lt;tr&gt;&lt;td&gt;rank ${rankNum}\&lt;\/td&gt;&lt;td&gt;${value.uname}&lt;\/td&gt;&lt;td&gt;${value.age} years old&lt;\/td&gt;&lt;\/tr&gt;<br>" +
            "  );<br>" +
            "};<br>" +
            'sg("chat").sortChildLineupWithNum("age", initFuncDemo, mainFuncDemo);</code></pre>'
        );
      } else {
        sg("chat").sortChildLineupWithNum("age", initFuncDemo, mainFuncDemo, sCLWNOrder, Boolean(Number(sCLWNTiedRankBool)), Boolean(Number(sCLWNOnLoadBool)), Boolean(Number(sCLWNRealTimeBool)));
        $("#code").html(
          '<pre class="prettyprint"><code>' +
            "const initFuncDemo = function (snapshot) {<br>" +
            '  $("#output__tbody").html("");<br>' +
            "};<br>" +
            "const mainFuncDemo = function (key, value, rankNum) {<br>" +
            '  $("#output__tbody").append(<br>' +
            "    &lt;tr&gt;&lt;td&gt;rank ${rankNum}\&lt;\/td&gt;&lt;td&gt;${value.uname}&lt;\/td&gt;&lt;td&gt;${value.age} years old&lt;\/td&gt;&lt;\/tr&gt;<br>" +
            "  );<br>" +
            "};<br>" +
            `sg("chat").sortChildLineupWithNum("age", initFuncDemo, mainFuncDemo, ${sCLWNOrder}, ${Boolean(Number(sCLWNTiedRankBool))}, ${Boolean(Number(sCLWNOnLoadBool))}, ${Boolean(Number(sCLWNRealTimeBool))});</code></pre>`
        );
        clearLocalStorage();
      }
      $("#custom__execute").on("click", function () {
        localStorage.setItem(
          "sCLWNOrder",
          $("#customML__order").val()
        );
        localStorage.setItem(
          "sCLWNTiedRankBool",
          $("#customML__tiedRankBool").val()
        );
        localStorage.setItem(
          "sCLWNOnLoadBool",
          $("#customML__onLoadBool").val()
        );

        localStorage.setItem(
          "sCLWNRealTimeBool",
          $("#customML__RealTimeBool").val()
        );

        location.reload();
      });

      $("#childEvent__trigger").on("click", async function () {
        set(ref(db, "chat/-N2qurrOFc4woZCUOK8T"), {
          uname: "Mia",
          age: 28,
          text: "Good night!",
          deleteFrag: false,
        });
        $("html,body").animate({ scrollTop: 0 }, "0.5");
        await wait(3);
        remove(ref(db, "chat/-N2qurrOFc4woZCUOK8T"));
      });

      function clearLocalStorage() {
        localStorage.removeItem("sCLWNOrder");
        localStorage.removeItem("sCLWNTiedRankBool");
        localStorage.removeItem("sCLWNOnLoadBool");
        localStorage.removeItem("sCLWNRealTimeBool");
      }
    </script>
  </body>
</html>
